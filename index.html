<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Terbaik</title>
<style>
:root{
  --bg:#f7f8fb; --card:#fff; --accent:#5c2cf7; --muted:#6b7280; --danger:#ff4d4f; --shadow:0 4px 12px rgba(0,0,0,0.08);
  font-family:Inter,system-ui,sans-serif
}
body{margin:0;background:var(--bg);color:#111827}
.container{max-width:720px;margin:auto;padding:12px}
header{display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--card);box-shadow:var(--shadow);border-radius:12px;margin-bottom:12px}
.logo{width:42px;height:42px;background:linear-gradient(135deg,#5c2cf7,#3ddc97);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px}
h1,h2,h3{margin:0;font-size:16px}
p{margin:0;font-size:13px;color:var(--muted)}
.card{background:var(--card);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:var(--shadow)}
input,select{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:8px;box-sizing:border-box;font-size:14px}
button{padding:10px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px}
.btn-primary{background:var(--accent);color:white}
.btn-secondary{background:#eef6ff;color:var(--accent)}
.btn-danger{background:var(--danger);color:white}
.hidden{display:none}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{border-bottom:1px solid #eee;padding:8px;text-align:left;font-size:13px}
.action-btns button{margin-right:6px}

/* Tombol hapus kategori — ringkas & profesional */
.category-delete-btn {
  padding: 2px 5px;        /* ringkas tapi masih nyaman diklik */
  font-size: 9px;         /* font lebih kecil */
  border-radius: 4px;      /* radius rapi */
  min-width: 0;            /* lebar minimal */
  height: 22px;            /* tinggi tombol pas */
  line-height: 18px;
  background-color: var(--danger);
  color: black;
  border: none;
  cursor: pointer;
  float: right;            /* tetap di kanan header kategori */
  transition: 0.2s;
}

.category-delete-btn:hover {
  background-color: #c62828;
}

/* Kategori header */
.category-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}
.categories .card{margin-bottom:35px}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div class="container" id="login-screen">
  <div class="card">
    <h2>Login Admin</h2>
    <input type="text" id="admin-user" placeholder="Username">
    <input type="password" id="admin-pass" placeholder="Password">
    <button class="btn-primary" id="login-btn">Masuk</button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div class="container hidden" id="admin-panel">
  <header>
    <div style="display:flex;align-items:center;gap:8px">
      <div class="logo">KS</div>
      <div>
        <h1>Khenenk Store</h1>
        <p>Panel Kontrol</p>
      </div>
    </div>
    <button class="btn-secondary" id="logout-btn">Keluar</button>
  </header>

  <!-- PANEL KONTROL -->
  <div class="card" id="panel-control">
    <button class="btn-secondary" id="total-users-btn">Total Pengguna: <span id="total-users">0</span></button>
    <button class="btn-secondary" id="total-saldo-btn">Total Saldo: Rp <span id="total-saldo">0</span></button>
  </div>

  <!-- DAFTAR PENGGUNA -->
  <div class="card hidden" id="user-panel">
    <button class="btn-secondary" id="back-main">Kembali</button>
    <input type="text" id="search-user" placeholder="Cari Nama, Email, WhatsApp" oninput="filterUsers(this.value)">
    <table class="table" id="user-table">
      <thead><tr><th>Nama</th><th>Email</th><th>Saldo</th><th>Aksi</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- PENCARIAN PRODUK GLOBAL -->
  <div class="card">
    <input type="text" id="search-product" placeholder="Cari Kategori, Produk, Denom, Harga" oninput="filterProducts(this.value)">
  </div>

  <!-- KATEGORI PRODUK -->
  <div id="categories-container" class="categories"></div>

  <!-- TAMBAH KATEGORI -->
  <div class="card">
    <input type="text" id="new-category-name" placeholder="Nama Kategori Baru">
    <button class="btn-primary" id="add-category-btn">Tambah Kategori</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBj1P1BlyVgusvpVJ_5TcJdqnffVm6In6E",
  authDomain: "tokomiken-6fc10.firebaseapp.com",
  projectId: "tokomiken-6fc10",
  storageBucket: "tokomiken-6fc10.appspot.com",
  messagingSenderId: "454827178083",
  appId: "1:454827178083:web:c83c3627d60942d5af2056",
  measurementId: "G-18DVM3HBNY"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// LOGIN
const loginScreen = document.getElementById('login-screen');
const adminPanel = document.getElementById('admin-panel');
const loginBtn = document.getElementById('login-btn');
const logoutBtn = document.getElementById('logout-btn');
const panelControl = document.getElementById('panel-control');
const userPanel = document.getElementById('user-panel');
const backMainBtn = document.getElementById('back-main');
const categoriesContainer = document.getElementById('categories-container');
const totalUsersBtn = document.getElementById('total-users-btn');
const totalSaldoBtn = document.getElementById('total-saldo-btn');

loginBtn.onclick = ()=>{
  const user=document.getElementById('admin-user').value.trim();
  const pass=document.getElementById('admin-pass').value.trim();
  if(user==='admin' && pass==='123'){
    loginScreen.classList.add('hidden');
    adminPanel.classList.remove('hidden');
    loadUsers();
    loadCategories();
  } else {
    alert('Login gagal!');
  }
};

logoutBtn.onclick=()=>{
  loginScreen.classList.remove('hidden');
  adminPanel.classList.add('hidden');
};

// LOAD USERS
function loadUsers(orderBySaldo=false){
  let query = db.collection('accounts');
  if(orderBySaldo) query = query.orderBy('saldo','desc');
  else query = query.orderBy('createdAt','desc');

  query.onSnapshot(snapshot=>{
    const tbody=document.querySelector('#user-table tbody');
    tbody.innerHTML='';
    let totalUsers = 0;
    let totalSaldo = 0;
    snapshot.forEach(doc=>{
      const u=doc.data();
      totalUsers++;
      totalSaldo += u.saldo||0;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="user-name" onclick="showUserDetail('${doc.id}')">${u.name||'-'}</td>
        <td>${u.email||'-'}</td>
        <td>Rp ${(u.saldo||0).toLocaleString()}</td>
        <td class="action-btns">
          <button class="btn-primary" onclick="addSaldo('${doc.id}')">+</button>
          <button class="btn-danger" onclick="subtractSaldo('${doc.id}')">-</button>
          <button class="btn-secondary" onclick="editUser('${doc.id}')">Edit</button>
        </td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('total-users').innerText = totalUsers;
    document.getElementById('total-saldo').innerText = totalSaldo.toLocaleString();
  });
}

// TOTAL PENGGUNA & TOTAL SALDO CLICK
totalUsersBtn.onclick = ()=>{
  panelControl.classList.add('hidden');
  categoriesContainer.classList.add('hidden');
  userPanel.classList.remove('hidden');
  loadUsers(false); // urut pendaftar terbaru
  filterUsers('');
};

totalSaldoBtn.onclick = ()=>{
  panelControl.classList.add('hidden');
  categoriesContainer.classList.add('hidden');
  userPanel.classList.remove('hidden');
  loadUsers(true); // urut saldo terbanyak
  filterUsers('');
};

// BACK TO MAIN
backMainBtn.onclick=()=>{
  panelControl.classList.remove('hidden');
  categoriesContainer.classList.remove('hidden');
  userPanel.classList.add('hidden');
};

// SALDO & EDIT USER
function addSaldo(userId){
  const amount = prompt("Masukkan nominal yang ingin ditambahkan:");
  if(amount!==null && amount!==''){
    const ref = db.collection('accounts').doc(userId);
    ref.get().then(doc=>{
      const saldo = Number(doc.data().saldo||0) + Number(amount);
      ref.update({saldo});
    });
  }
}

function subtractSaldo(userId){
  const amount = prompt("Masukkan nominal yang ingin dikurangi:");
  if(amount!==null && amount!==''){
    const ref = db.collection('accounts').doc(userId);
    ref.get().then(doc=>{
      const saldo = Math.max((Number(doc.data().saldo||0) - Number(amount)),0);
      ref.update({saldo});
    });
  }
}

function editUser(userId){
  const ref = db.collection('accounts').doc(userId);
  ref.get().then(doc=>{
    const data = doc.data();
    const email = prompt("Edit Email:", data.email||'');
    const whatsapp = prompt("Edit WhatsApp:", data.whatsapp||'');
    const password = prompt("Edit Password:", data.password||'');
    ref.update({email, whatsapp, password});
  });
}

// FILTER USER
function filterUsers(value){
  const filter = value.toLowerCase();
  document.querySelectorAll('#user-table tbody tr').forEach(tr=>{
    const text = tr.innerText.toLowerCase();
    tr.style.display = text.includes(filter) ? '' : 'none';
  });
}

// BAGIAN 2 – PRODUK PER KATEGORI
// ================== CATEGORIES ==================
function loadCategories(){
  db.collection('categories').orderBy('name').onSnapshot(snapshot=>{
    categoriesContainer.innerHTML='';
    snapshot.forEach(doc=>{
      const category = doc.data();
      const catCard = document.createElement('div');
      catCard.classList.add('card');

      catCard.innerHTML=`
        <div class="category-header" onclick="toggleCategory('${doc.id}')">
          <h3>${category.name}</h3>
          <button class="btn-danger" onclick="deleteCategory(event,'${doc.id}')">Hapus Kategori</button>
        </div>
        <div class="category-products hidden" id="cat-${doc.id}">
          <input type="text" placeholder="Operator" class="prod-operator">
          <input type="text" placeholder="Denom" class="prod-denom">
          <input type="number" placeholder="Harga" class="prod-price">
          <button class="btn-primary" onclick="addProduct('${doc.id}',this)">Tambah Produk</button>
          <table class="table">
            <thead><tr><th>Operator</th><th>Denom</th><th>Harga</th><th>Aksi</th></tr></thead>
            <tbody id="prod-table-${doc.id}"></tbody>
          </table>
        </div>
      `;
      categoriesContainer.appendChild(catCard);
      loadProducts(doc.id);
    });
  });
}

// TAMBAH KATEGORI
document.getElementById('add-category-btn').onclick=()=>{
  const name = document.getElementById('new-category-name').value.trim();
  if(!name) return alert("Isi nama kategori!");
  db.collection('categories').add({name}).then(()=>{
    document.getElementById('new-category-name').value='';
  });
}

// HAPUS KATEGORI
function deleteCategory(e,catId){
  e.stopPropagation();
  if(!confirm("Hapus kategori ini beserta produknya?")) return;
  // Hapus produk kategori
  db.collection('products').where("categoryId","==",catId).get().then(snap=>{
    snap.forEach(doc=>doc.ref.delete());
  });
  db.collection('categories').doc(catId).delete();
}

// TOGGLE PRODUK PER KATEGORI
function toggleCategory(catId){
  const div = document.getElementById('cat-'+catId);
  div.classList.toggle('hidden');
}

// TAMBAH PRODUK
function addProduct(catId,btn){
  const parent = btn.parentElement;
  const operator = parent.querySelector('.prod-operator').value.trim();
  const denom = parent.querySelector('.prod-denom').value.trim();
  const price = Number(parent.querySelector('.prod-price').value.trim());
  if(!operator || !denom || !price) return alert("Lengkapi semua kolom produk!");
  db.collection('products').add({categoryId:catId,operator,denom,price}).then(()=>{
    parent.querySelector('.prod-operator').value='';
    parent.querySelector('.prod-denom').value='';
    parent.querySelector('.prod-price').value='';
  });
}

// LOAD PRODUK PER KATEGORI
function loadProducts(catId){
  db.collection('products').where("categoryId","==",catId).onSnapshot(snapshot=>{
    const tbody = document.getElementById('prod-table-'+catId);
    tbody.innerHTML='';
    snapshot.forEach(doc=>{
      const p = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML=`
        <td>${p.operator}</td>
        <td>${p.denom}</td>
        <td>Rp ${p.price.toLocaleString()}</td>
        <td>
          <button class="btn-primary" onclick="editProduct('${doc.id}')">Edit</button>
          <button class="btn-danger" onclick="deleteProduct('${doc.id}')">Hapus</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

// EDIT PRODUK
function editProduct(prodId){
  db.collection('products').doc(prodId).get().then(doc=>{
    if(!doc.exists) return alert("Produk tidak ditemukan!");
    const data = doc.data();
    const operator = prompt("Operator:",data.operator||"");
    if(operator===null) return;
    const denom = prompt("Denom:",data.denom||"");
    if(denom===null) return;
    const price = prompt("Harga:",data.price||0);
    if(price===null) return;
    db.collection('products').doc(prodId).update({operator,denom,price:Number(price)});
  });
}

// HAPUS PRODUK
function deleteProduct(prodId){
  if(!confirm("Hapus produk ini?")) return;
  db.collection('products').doc(prodId).delete();
}

// FILTER PRODUK
function filterProducts(query){
  query = query.toLowerCase();
  document.querySelectorAll('.categories .card').forEach(card=>{
    const catName = card.querySelector('h3').innerText.toLowerCase();
    const prods = card.querySelectorAll('tbody tr');
    let visible = catName.includes(query);
    prods.forEach(tr=>{
      const tds = Array.from(tr.children).slice(0,3).map(td=>td.innerText.toLowerCase());
      if(tds.some(t=>t.includes(query))) visible=true;
    });
    card.style.display = visible?'block':'none';
  });
}

// FILTER USERS
function filterUsers(query){
  query = query.toLowerCase();
  document.querySelectorAll('#user-table tbody tr').forEach(tr=>{
    const tds = Array.from(tr.children).slice(0,3);
    const match = tds.some(td=>td.innerText.toLowerCase().includes(query));
    tr.style.display = match?'table-row':'none';
  });
}
</script>
</body>
</html>
